# Hammerspace Monitoring: Prometheus and Grafana setup and installation

This github repo will walk through steps to setup and configure Prometheus and Grafana via Docker for Hammerspace monitoring and alerting.

## Requirements

- Python 3.6+ with `requests` and `PyYAML` modules
- Docker and docker-compose
- Hammerspace cluster (running and accessible)
- Network access to Hammerspace cluster on ports 9100-9105
- Valid Hammerspace credentials

## Hammerspace Prometheus endpoint target setup

1. Run `python setup_prometheus.py`. Provide your cluster name (fully qualified domain name) as well as username and password. You can also configure these parameters as environment variables: HS_HOSTNAME, HS_USERNAME, HS_PASSWORD
2. Check the output of the `python setup_prometheus.py` to confirm everything ran smoothly.
3. If everything worked, you will now have the hammerspace_prometheus.yml ready to go.

### Appending to existing Prometheus configuration
If you already have a Prometheus setup, you can append Hammerspace monitoring to it:
```bash
python setup_prometheus.py --existing-config /path/to/your/prometheus.yml
```
This will add the Hammerspace scrape configs to your existing file instead of creating a new one.

## Start up Prometheus and Grafana via docker

1. Check the docker-compose.yml to confirm it's configured to work in your environment. Change the default Grafana admin user and password if needed (GF_SECURITY_ADMIN_USER, GF_SECURITY_ADMIN_PASSWORD).
2. Run `docker-compose up -d`
3. Check logs to confirm things are up and running: 
    - `docker logs -n 100 prometheus` - Don't worry if you see "Error on ingesting samples with different value but same timestamp". Those are minor issues that will get resolved in future Hammerspace releases.
    - `docker logs -n 100 grafana` - Look for something like "inserting datasource from configuration"
4. After a minute or two, confirm everything is "scraping" correctly by going here: http://localhost:9090/targets
5. Finally, go to the Grafana UI and confirm you can see metrics rolling in here: http://localhost:3000/a/grafana-metricsdrilldown-app/drilldown?search_txt=hammerspace

## Grafana Dashboards
A pre-built Hammerspace system dashboard is included in `dashboards/hammerspace_system_dashboard.json`. To import it:
1. Go to Grafana UI (http://localhost:3000)
2. Navigate to Dashboards â†’ Import
3. Upload the JSON file from the `dashboards/` directory

## Generated Files
- `hammerspace_prometheus.yml` - Generated by `setup_prometheus.py`, contains Prometheus scrape configs
- This file is required by `docker-compose.yml` and must exist before starting containers

## Troubleshooting
- **File not found errors**: Ensure `hammerspace_prometheus.yml` exists by running `setup_prometheus.py` first
- **Connection refused**: Verify network access to Hammerspace cluster ports 9100-9105
- **Duplicate job names**: If appending to existing config, the script will merge configurations safely
- **Missing Python modules**: Install required modules with `pip install requests PyYAML`

